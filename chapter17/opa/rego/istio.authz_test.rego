package istio.authz

test_no_az_header {
    not allow with input as {"attributes":{"destination":{"address":{"socketAddress":{"address":"10.240.189.183","portValue":8080}},"principal":"spiffe://cluster.local/ns/istio-hello-world/sa/default"},"metadataContext":{},"request":{"http":{"headers":{":authority":"service.192-168-2-96.nip.io",":method":"GET",":path":"/headers",":scheme":"http","accept":"*/*","user-agent":"curl/8.4.0","x-b3-sampled":"1","x-b3-spanid":"eeedbc2bae153b9b","x-b3-traceid":"a67a72f9816e1e65eeedbc2bae153b9b","x-envoy-attempt-count":"1","x-envoy-internal":"true","x-forwarded-client-cert":"By=spiffe://cluster.local/ns/istio-hello-world/sa/default;Hash=6b296e802ec6db326e85f150166414d3ccb513fe28ae1f2c0617c3d310285708;Subject=\"\";URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account","x-forwarded-for":"192.168.2.222","x-forwarded-proto":"http","x-request-id":"5d3a8a97-ebf5-939e-8b58-012651a6040b"},"host":"service.192-168-2-96.nip.io","id":"4346174809586483911","method":"GET","path":"/headers","protocol":"HTTP/1.1","scheme":"http"},"time":"2024-02-27T02:04:07.046417Z"},"source":{"address":{"socketAddress":{"address":"10.240.189.185","portValue":60358}},"principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"}},"parsed_body":null,"parsed_path":["headers"],"parsed_query":{},"truncated_body":false,"version":{"encoding":"protojson","ext_authz":"v3"}}
}

test_az_header_not_bearer {
    not allow with input as {"attributes":{"destination":{"address":{"socketAddress":{"address":"10.240.189.183","portValue":8080}},"principal":"spiffe://cluster.local/ns/istio-hello-world/sa/default"},"metadataContext":{},"request":{"http":{"headers":{":authority":"service.192-168-2-96.nip.io",":method":"GET",":path":"/headers",":scheme":"http","accept":"*/*","authorization":"WRONG","user-agent":"curl/8.4.0","x-b3-sampled":"1","x-b3-spanid":"eeedbc2bae153b9b","x-b3-traceid":"a67a72f9816e1e65eeedbc2bae153b9b","x-envoy-attempt-count":"1","x-envoy-internal":"true","x-forwarded-client-cert":"By=spiffe://cluster.local/ns/istio-hello-world/sa/default;Hash=6b296e802ec6db326e85f150166414d3ccb513fe28ae1f2c0617c3d310285708;Subject=\"\";URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account","x-forwarded-for":"192.168.2.222","x-forwarded-proto":"http","x-request-id":"5d3a8a97-ebf5-939e-8b58-012651a6040b"},"host":"service.192-168-2-96.nip.io","id":"4346174809586483911","method":"GET","path":"/headers","protocol":"HTTP/1.1","scheme":"http"},"time":"2024-02-27T02:04:07.046417Z"},"source":{"address":{"socketAddress":{"address":"10.240.189.185","portValue":60358}},"principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"}},"parsed_body":null,"parsed_path":["headers"],"parsed_query":{},"truncated_body":false,"version":{"encoding":"protojson","ext_authz":"v3"}}
}

test_az_header_not_jwt {
    not allow with input as {"attributes":{"destination":{"address":{"socketAddress":{"address":"10.240.189.183","portValue":8080}},"principal":"spiffe://cluster.local/ns/istio-hello-world/sa/default"},"metadataContext":{},"request":{"http":{"headers":{":authority":"service.192-168-2-96.nip.io",":method":"GET",":path":"/headers",":scheme":"http","accept":"*/*","authorization":"Bearer WRONG","user-agent":"curl/8.4.0","x-b3-sampled":"1","x-b3-spanid":"eeedbc2bae153b9b","x-b3-traceid":"a67a72f9816e1e65eeedbc2bae153b9b","x-envoy-attempt-count":"1","x-envoy-internal":"true","x-forwarded-client-cert":"By=spiffe://cluster.local/ns/istio-hello-world/sa/default;Hash=6b296e802ec6db326e85f150166414d3ccb513fe28ae1f2c0617c3d310285708;Subject=\"\";URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account","x-forwarded-for":"192.168.2.222","x-forwarded-proto":"http","x-request-id":"5d3a8a97-ebf5-939e-8b58-012651a6040b"},"host":"service.192-168-2-96.nip.io","id":"4346174809586483911","method":"GET","path":"/headers","protocol":"HTTP/1.1","scheme":"http"},"time":"2024-02-27T02:04:07.046417Z"},"source":{"address":{"socketAddress":{"address":"10.240.189.185","portValue":60358}},"principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"}},"parsed_body":null,"parsed_path":["headers"],"parsed_query":{},"truncated_body":false,"version":{"encoding":"protojson","ext_authz":"v3"}}
}

test_groups_exist {
    not allow with input as {"attributes":{"destination":{"address":{"socketAddress":{"address":"10.240.189.183","portValue":8080}},"principal":"spiffe://cluster.local/ns/istio-hello-world/sa/default"},"metadataContext":{},"request":{"http":{"headers":{":authority":"service.192-168-2-96.nip.io",":method":"GET",":path":"/headers",":scheme":"http","accept":"*/*","authorization":"Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJPbmxpbmUgSldUIEJ1aWxkZXIiLCJpYXQiOjE3MDkwNDM2MjIsImV4cCI6MTc0MDU3OTYyMiwiYXVkIjoid3d3LmV4YW1wbGUuY29tIiwic3ViIjoianJvY2tldEBleGFtcGxlLmNvbSIsIkdpdmVuTmFtZSI6IkpvaG5ueSIsIlN1cm5hbWUiOiJSb2NrZXQiLCJFbWFpbCI6Impyb2NrZXRAZXhhbXBsZS5jb20iLCJSb2xlIjpbIk1hbmFnZXIiLCJQcm9qZWN0IEFkbWluaXN0cmF0b3IiXX0.D0fkmrxHSNHgLTSrIW2LuldLS_YCpbcu89mIt7zfcDs","user-agent":"curl/8.4.0","x-b3-sampled":"1","x-b3-spanid":"eeedbc2bae153b9b","x-b3-traceid":"a67a72f9816e1e65eeedbc2bae153b9b","x-envoy-attempt-count":"1","x-envoy-internal":"true","x-forwarded-client-cert":"By=spiffe://cluster.local/ns/istio-hello-world/sa/default;Hash=6b296e802ec6db326e85f150166414d3ccb513fe28ae1f2c0617c3d310285708;Subject=\"\";URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account","x-forwarded-for":"192.168.2.222","x-forwarded-proto":"http","x-request-id":"5d3a8a97-ebf5-939e-8b58-012651a6040b"},"host":"service.192-168-2-96.nip.io","id":"4346174809586483911","method":"GET","path":"/headers","protocol":"HTTP/1.1","scheme":"http"},"time":"2024-02-27T02:04:07.046417Z"},"source":{"address":{"socketAddress":{"address":"10.240.189.185","portValue":60358}},"principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"}},"parsed_body":null,"parsed_path":["headers"],"parsed_query":{},"truncated_body":false,"version":{"encoding":"protojson","ext_authz":"v3"}}
}

test_fail_seperation_of_duties {
    not allow with input as {"attributes":{"destination":{"address":{"socketAddress":{"address":"10.240.189.183","portValue":8080}},"principal":"spiffe://cluster.local/ns/istio-hello-world/sa/default"},"metadataContext":{},"request":{"http":{"headers":{":authority":"service.192-168-2-96.nip.io",":method":"GET",":path":"/headers",":scheme":"http","accept":"*/*","authorization":"Bearer eyJraWQiOiJDPU15Q291bnRyeSwgU1Q9LCBMPU15IENsdXN0ZXIsIE89TXlPcmcsIE9VPUt1YmVybmV0ZXMsIENOPXVuaXNvbi1zYW1sMi1ycC1zaWctQz1NeUNvdW50cnksIFNUPSwgTD1NeSBDbHVzdGVyLCBPPU15T3JnLCBPVT1LdWJlcm5ldGVzLCBDTj11bmlzb24tc2FtbDItcnAtc2lnLTE3MDg3OTM0ODcwNzAiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJodHRwczovL2s4c291LmFwcHMuMTkyLTE2OC0yLTk2Lm5pcC5pby9hdXRoL2lkcC9rOHNJZHAiLCJhdWQiOiJrdWJlcm5ldGVzIiwiZXhwIjoxNzA5MDQzOTg3LCJqdGkiOiJsNU9HdWlKM256SV9URmd3Mk02Q0dRIiwiaWF0IjoxNzA5MDQzOTI3LCJuYmYiOjE3MDkwNDM4MDcsInN1YiI6Im1tb3NsZXkiLCJuYW1lIjoiIE1vc2xleSIsImdyb3VwcyI6WyJjbj1rOHMtY2x1c3Rlci1hZG1pbnMsb3U9R3JvdXBzLERDPWRvbWFpbixEQz1jb20iLCJjbj1ncm91cDIsb3U9R3JvdXBzLERDPWRvbWFpbixEQz1jb20iXSwicHJlZmVycmVkX3VzZXJuYW1lIjoibW1vc2xleSIsImVtYWlsIjoibW1vc2xleUB0cmVtb2xvLmRldiJ9.hhbDSKqvSRwSKACqu5DXE4USs-w6PWKeC-Cc2pxF7S-Wda-5MCN1B2rpvPbWi-dzjauN6xfWC3AB7EJK18HtORx6_BEfNSa7f7QkQSlr1j-kWAQVTJQrVt-NdmiFpYwxWGE2XIlhfjKTBadJ2fx68tBoP9R0Mwf38K9Giwka_nB-XhFKi9N_yj5PIMHjKrF3euREP03FOaSbGIId84UaBnz2MF98er25WzIjpODdrUachK1LSK5lhAwSs_nI5kRBOqHIMdxXK_AO8kaBmXgfhpZcdprV7mJ1SiK1g2NoUY0lpQmZhcktoKa0RWaiLrj2Cs6tjc038WLGF8RJgWbpmg","user-agent":"curl/8.4.0","x-b3-sampled":"1","x-b3-spanid":"eeedbc2bae153b9b","x-b3-traceid":"a67a72f9816e1e65eeedbc2bae153b9b","x-envoy-attempt-count":"1","x-envoy-internal":"true","x-forwarded-client-cert":"By=spiffe://cluster.local/ns/istio-hello-world/sa/default;Hash=6b296e802ec6db326e85f150166414d3ccb513fe28ae1f2c0617c3d310285708;Subject=\"\";URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account","x-forwarded-for":"192.168.2.222","x-forwarded-proto":"http","x-request-id":"5d3a8a97-ebf5-939e-8b58-012651a6040b"},"host":"service.192-168-2-96.nip.io","id":"4346174809586483911","method":"GET","path":"/headers","protocol":"HTTP/1.1","scheme":"http"},"time":"2024-02-27T02:04:07.046417Z"},"source":{"address":{"socketAddress":{"address":"10.240.189.185","portValue":60358}},"principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"}},"parsed_body":null,"parsed_path":["headers"],"parsed_query":{},"truncated_body":false,"version":{"encoding":"protojson","ext_authz":"v3"}}
}

test_allow_group_list {
    allow with input as {"attributes":{"destination":{"address":{"socketAddress":{"address":"10.240.189.183","portValue":8080}},"principal":"spiffe://cluster.local/ns/istio-hello-world/sa/default"},"metadataContext":{},"request":{"http":{"headers":{":authority":"service.192-168-2-96.nip.io",":method":"GET",":path":"/headers",":scheme":"http","accept":"*/*","authorization":"Bearer eyJraWQiOiJDPU15Q291bnRyeSwgU1Q9LCBMPU15IENsdXN0ZXIsIE89TXlPcmcsIE9VPUt1YmVybmV0ZXMsIENOPXVuaXNvbi1zYW1sMi1ycC1zaWctQz1NeUNvdW50cnksIFNUPSwgTD1NeSBDbHVzdGVyLCBPPU15T3JnLCBPVT1LdWJlcm5ldGVzLCBDTj11bmlzb24tc2FtbDItcnAtc2lnLTE3MDg3OTM0ODcwNzAiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJodHRwczovL2s4c291LmFwcHMuMTkyLTE2OC0yLTk2Lm5pcC5pby9hdXRoL2lkcC9rOHNJZHAiLCJhdWQiOiJrdWJlcm5ldGVzIiwiZXhwIjoxNzA5MDQ0MTE4LCJqdGkiOiJDbFI2ZGtDRUVvbmVLWDFmaGFZYnhBIiwiaWF0IjoxNzA5MDQ0MDU4LCJuYmYiOjE3MDkwNDM5MzgsInN1YiI6InBpcGVsaW5lX3N2Y19hY2NvdW50IiwibmFtZSI6IiBzdmMiLCJncm91cHMiOlsiY249azhzLWNsdXN0ZXItYWRtaW5zLG91PUdyb3VwcyxEQz1kb21haW4sREM9Y29tIl0sInByZWZlcnJlZF91c2VybmFtZSI6InBpcGVsaW5leC05NS14c3ZjeC05NS14YWNjb3VudCIsImVtYWlsIjoiIn0.Lk4Qoc4EC9wg5QrqhtmYk_4aDVQ4pQSqk2orHp9hTAOOark_MJReORymeoHzFCZnoUjKhokkOTu2ZJ5gPcHMHbqI8MNKSaIt3U7TlJ6Sf7B76rynGfYpET8p9AKV4IAbrVnKMVwA68gAKTptggCBFDvV-vojnMx8gGqXRNvp7L4nT0fKUkXdYbBCITev9C5yyQ6JY9tK5v4SIys8G2X_NVh6ULsRpb_q-jHO2QcEMTrlvRnjilGXIXVUc8bkO0JUJHrVto4FCO4iMhe4bm1c8B3vEjih1BfQAYSy6MUrrEjQyrjwufSr8YNZ-JcMyJ45ItnEzBQVKAamuiy1IxYX-g","user-agent":"curl/8.4.0","x-b3-sampled":"1","x-b3-spanid":"eeedbc2bae153b9b","x-b3-traceid":"a67a72f9816e1e65eeedbc2bae153b9b","x-envoy-attempt-count":"1","x-envoy-internal":"true","x-forwarded-client-cert":"By=spiffe://cluster.local/ns/istio-hello-world/sa/default;Hash=6b296e802ec6db326e85f150166414d3ccb513fe28ae1f2c0617c3d310285708;Subject=\"\";URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account","x-forwarded-for":"192.168.2.222","x-forwarded-proto":"http","x-request-id":"5d3a8a97-ebf5-939e-8b58-012651a6040b"},"host":"service.192-168-2-96.nip.io","id":"4346174809586483911","method":"GET","path":"/headers","protocol":"HTTP/1.1","scheme":"http"},"time":"2024-02-27T02:04:07.046417Z"},"source":{"address":{"socketAddress":{"address":"10.240.189.185","portValue":60358}},"principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"}},"parsed_body":null,"parsed_path":["headers"],"parsed_query":{},"truncated_body":false,"version":{"encoding":"protojson","ext_authz":"v3"}}
}

test_allow_group_not_list {
    allow with input as {"attributes":{"destination":{"address":{"socketAddress":{"address":"10.240.189.183","portValue":8080}},"principal":"spiffe://cluster.local/ns/istio-hello-world/sa/default"},"metadataContext":{},"request":{"http":{"headers":{":authority":"service.192-168-2-96.nip.io",":method":"GET",":path":"/headers",":scheme":"http","accept":"*/*","authorization":"Bearer eyJraWQiOiJDPU15Q291bnRyeSwgU1Q9LCBMPU15IENsdXN0ZXIsIE89TXlPcmcsIE9VPUt1YmVybmV0ZXMsIENOPXVuaXNvbi1zYW1sMi1ycC1zaWctQz1NeUNvdW50cnksIFNUPSwgTD1NeSBDbHVzdGVyLCBPPU15T3JnLCBPVT1LdWJlcm5ldGVzLCBDTj11bmlzb24tc2FtbDItcnAtc2lnLTE3MDg3OTM0ODcwNzAiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJodHRwczovL2s4c291LmFwcHMuMTkyLTE2OC0yLTk2Lm5pcC5pby9hdXRoL2lkcC9rOHNJZHAiLCJhdWQiOiJrdWJlcm5ldGVzIiwiZXhwIjoxNzA5MDQ0MTE4LCJqdGkiOiJDbFI2ZGtDRUVvbmVLWDFmaGFZYnhBIiwiaWF0IjoxNzA5MDQ0MDU4LCJuYmYiOjE3MDkwNDM5MzgsInN1YiI6InBpcGVsaW5lX3N2Y19hY2NvdW50IiwibmFtZSI6IiBzdmMiLCJncm91cHMiOiJjbj1rOHMtY2x1c3Rlci1hZG1pbnMsb3U9R3JvdXBzLERDPWRvbWFpbixEQz1jb20iLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJwaXBlbGluZXgtOTUteHN2Y3gtOTUteGFjY291bnQiLCJlbWFpbCI6IiJ9.Lk4Qoc4EC9wg5QrqhtmYk_4aDVQ4pQSqk2orHp9hTAOOark_MJReORymeoHzFCZnoUjKhokkOTu2ZJ5gPcHMHbqI8MNKSaIt3U7TlJ6Sf7B76rynGfYpET8p9AKV4IAbrVnKMVwA68gAKTptggCBFDvV-vojnMx8gGqXRNvp7L4nT0fKUkXdYbBCITev9C5yyQ6JY9tK5v4SIys8G2X_NVh6ULsRpb_q-jHO2QcEMTrlvRnjilGXIXVUc8bkO0JUJHrVto4FCO4iMhe4bm1c8B3vEjih1BfQAYSy6MUrrEjQyrjwufSr8YNZ-JcMyJ45ItnEzBQVKAamuiy1IxYX-g","user-agent":"curl/8.4.0","x-b3-sampled":"1","x-b3-spanid":"eeedbc2bae153b9b","x-b3-traceid":"a67a72f9816e1e65eeedbc2bae153b9b","x-envoy-attempt-count":"1","x-envoy-internal":"true","x-forwarded-client-cert":"By=spiffe://cluster.local/ns/istio-hello-world/sa/default;Hash=6b296e802ec6db326e85f150166414d3ccb513fe28ae1f2c0617c3d310285708;Subject=\"\";URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account","x-forwarded-for":"192.168.2.222","x-forwarded-proto":"http","x-request-id":"5d3a8a97-ebf5-939e-8b58-012651a6040b"},"host":"service.192-168-2-96.nip.io","id":"4346174809586483911","method":"GET","path":"/headers","protocol":"HTTP/1.1","scheme":"http"},"time":"2024-02-27T02:04:07.046417Z"},"source":{"address":{"socketAddress":{"address":"10.240.189.185","portValue":60358}},"principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"}},"parsed_body":null,"parsed_path":["headers"],"parsed_query":{},"truncated_body":false,"version":{"encoding":"protojson","ext_authz":"v3"}}
}