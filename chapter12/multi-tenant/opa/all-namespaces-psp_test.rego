package k8senforcepsppernamespace

test_priv_escalation_not_present {
    checkForPrivEscalationPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-quota","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_priv_escalation_present {
    not checkForPrivEscalationPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-psp","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_capabilites_not_present {
    checkForCapabilitiesPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-quota","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_capabilites_present {
    not checkForCapabilitiesPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-psp","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_sysctls_not_present {
    checkForSysCtlsPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-quota","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_sysctls_present {
    not checkForSysCtlsPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-psp","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_hostnamespace_not_present {
    checkHostNamespacePolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-quota","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_hostnamespace_present {
    not checkHostNamespacePolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-psp","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_hostfilesystem_not_present {
    checkHostFileSystemPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-quota","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_hostfilesystem_present {
    not checkHostFileSystemPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-psp","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_hostnetwork_not_present {
    checkHostNetworkPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-quota","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_hostnetwork_present {
    not checkHostNetworkPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-psp","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_priv_container_not_present {
    checkPrivContainerPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-quota","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_priv_container_present {
    not checkPrivContainerPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-psp","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_proc_mount_not_present {
    checkProcMountPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-quota","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_proc_mount_present {
    not checkProcMountPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-psp","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_allowedusers_not_present {
    checkAllowedUsersPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-quota","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}

test_allowedusers_present {
    not checkAllowedUsersPolicy with input as {"apiVersion":"admission.k8s.io/v1","kind":"AdmissionReview","parameters":{"registries":["x","quay.io/"]},"review":{"uid":"705ab4f5-6393-11e8-b7cc-42010a800002","kind":{"group":"autoscaling","version":"v1","kind":"Scale"},"resource":{"group":"apps","version":"v1","resource":"deployments"},"subResource":"scale","requestKind":{"group":"autoscaling","version":"v1","kind":"Scale"},"requestResource":{"group":"apps","version":"v1","resource":"deployments"},"requestSubResource":"scale","name":"my-deployment","namespace":"my-namespace","operation":"CREATE","userInfo":{"username":"admin","uid":"014fbff9a07c","groups":["system:authenticated","my-admin-group"],"extra":{"some-key":["some-value1","some-value2"]}},"object":{"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{"cni.projectcalico.org/podIP":"10.240.189.147/32","cni.projectcalico.org/podIPs":"10.240.189.147/32","kubernetes.io/psp":"pod-security-policy-default"},"creationTimestamp":"2020-07-05T02:00:04Z","generateName":"check-certs-orchestra-1593914400-","labels":{"controller-uid":"711dc21e-3bd2-4769-ba92-465fd057bded","job-name":"check-certs-orchestra-1593914400"},"name":"check-certs-orchestra-1593914400-pd5f5","namespace":"ns-with-psp","ownerReferences":[{"apiVersion":"batch/v1","blockOwnerDeletion":true,"controller":true,"kind":"Job","name":"check-certs-orchestra-1593914400","uid":"711dc21e-3bd2-4769-ba92-465fd057bded"}],"resourceVersion":"91886","selfLink":"/api/v1/namespaces/openunison/pods/check-certs-orchestra-1593914400-pd5f5","uid":"f72ff715-a9f5-462b-b1a7-892086dee3aa"},"spec":{"containers":[{"command":["java","-jar","/usr/local/artifactdeploy/artifact-deploy.jar","-extraCertsPath","/etc/extracerts","-installScriptURL","file:///etc/input-maps/cert-check.js","-kubernetesURL","https://kubernetes.default.svc.cluster.local","-rootCaPath","/var/run/secrets/kubernetes.io/serviceaccount/ca.crt","-secretsPath","/etc/input-maps/input.props","-tokenPath","/var/run/secrets/kubernetes.io/serviceaccount/token","-deploymentTemplate","file:///etc/input-maps/deployment.yaml"],"env":[{"name":"CERT_DAYS_EXPIRE","value":"10"}],"image":"quay.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0","imagePullPolicy":"IfNotPresent","name":"check-certs-orchestra","resources":{},"securityContext":{"runAsUser":1},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/extracerts","name":"extra-certs-dir","readOnly":true},{"mountPath":"/etc/input-maps","name":"input-maps","readOnly":true},{"mountPath":"/var/run/secrets/kubernetes.io/serviceaccount","name":"openunison-operator-token-6jtv2","readOnly":true}]}],"dnsPolicy":"ClusterFirst","enableServiceLinks":true,"nodeName":"cluster01-worker","priority":0,"restartPolicy":"Never","schedulerName":"default-scheduler","securityContext":{"fsGroup":1,"supplementalGroups":[1]},"serviceAccount":"openunison-operator","serviceAccountName":"openunison-operator","terminationGracePeriodSeconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationSeconds":300},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationSeconds":300}],"volumes":[{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"extra-certs-dir"},{"configMap":{"defaultMode":420,"name":"cert-controller-js-orchestra"},"name":"input-maps"},{"name":"openunison-operator-token-6jtv2","secret":{"defaultMode":420,"secretName":"openunison-operator-token-6jtv2"}}]}},"oldObject":null,"options":null,"dryRun":false}}  with data.inventory as {"namespace":{"ns-with-no-quota":{},"ns-with-quota":{"v1":{"ResourceQuota":{"memory-quota":{"kind":"ResourceQuota","apiVersion":"v1","metadata":{"name":"memory-quota","namespace":"ns-with-quota"},"spec":{"hard":{"requests.memory":"1G","limits.memory":"1G"}}}}}}},"cluster":{"constraints.gatekeeper.sh/v1beta1":{"K8sPSPAllowPrivilegeEscalationContainer":{"privilege-escalation-deny-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowPrivilegeEscalationContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"privilege-escalation-deny-all","resourceVersion":"266073","uid":"e67352fd-bb66-4dbc-838c-c12007932b29"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPCapabilities":{"capabilities-drop-all":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPCapabilities","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":4,"name":"capabilities-drop-all","resourceVersion":"270391","uid":"a8fa32ac-2b9a-4518-bd83-a174318b87c9"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedCapabilities":[],"requiredDropCapabilities":["all"]}},"status":{}}},"K8sPSPForbiddenSysctls":{"psp-forbid-all-sysctls":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPForbiddenSysctls","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":1,"name":"psp-forbid-all-sysctls","resourceVersion":"270928","uid":"3bf16dc7-ca6f-4be4-8c3f-7f82845b30bf"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"forbiddenSysctls":["*"]}},"status":{}}},"K8sPSPHostFilesystem":{"psp-deny-host-filesystem":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostFilesystem","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:31Z","generation":2,"name":"psp-deny-host-filesystem","resourceVersion":"271470","uid":"9e976cb0-d003-425d-b89f-07c6852b07df"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"allowedHostPaths":[]}},"status":{}}},"K8sPSPHostNamespace":{"psp-bloack-all-host-namespace":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNamespace","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-bloack-all-host-namespace","resourceVersion":"272370","uid":"80de6407-87e1-4c9a-b6cb-f94bf6776e66"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPHostNetworkingPorts":{"psp-deny-all-host-network-ports":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPHostNetworkingPorts","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":2,"name":"psp-deny-all-host-network-ports","resourceVersion":"272730","uid":"144070b1-6d41-4081-908c-7ffafc6e6cf0"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"hostNetwork":false}},"status":{}}},"K8sPSPPrivilegedContainer":{"psp-deny-all-privileged-container":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPPrivilegedContainer","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-deny-all-privileged-container","resourceVersion":"273092","uid":"6a9b505e-19c4-4748-b1d6-871535e19b35"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]}},"status":{}}},"K8sPSPProcMount":{"psp-proc-mount-default":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPProcMount","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:32Z","generation":1,"name":"psp-proc-mount-default","resourceVersion":"273633","uid":"85e753b2-f51c-4df6-a1cf-6e8c6215624b"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"procMount":"Default"}},"status":{}}},"K8sPSPAllowedUsers":{"psp-pods-allowed-user-ranges":{"apiVersion":"constraints.gatekeeper.sh/v1beta1","kind":"K8sPSPAllowedUsers","metadata":{"annotations":{},"creationTimestamp":"2021-07-24T17:56:33Z","generation":1,"name":"psp-pods-allowed-user-ranges","resourceVersion":"273804","uid":"180dd218-904c-452a-bd50-7e64751b1117"},"spec":{"match":{"namespaces":["ns-with-psp"],"kinds":[{"apiGroups":[""],"kinds":["Pod"]}]},"parameters":{"fsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsGroup":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"runAsUser":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"},"supplementalGroups":{"ranges":[{"max":4294967294,"min":100}],"rule":"MustRunAs"}}},"status":{}}}}}}
}